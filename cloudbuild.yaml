steps:
  - name: 'gcr.io/cloud-builders/docker'
    dir: 'backend'
    args: [
      'build',
      '-t','${_REGION}-docker.pkg.dev/${PROJECT_ID}/containers/grow-backend:$SHORT_SHA',
      '-f','Dockerfile','.'
    ]

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push','${_REGION}-docker.pkg.dev/${PROJECT_ID}/containers/grow-backend:$SHORT_SHA']

  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args: [
      'run','deploy','${_SERVICE}',
      '--image','${_REGION}-docker.pkg.dev/${PROJECT_ID}/containers/grow-backend:$SHORT_SHA',
      '--region','${_REGION}',
      '--platform','managed',
      '--allow-unauthenticated',
      '--set-secrets','GEMINI_API_KEY=GEMINI_API_KEY:latest'
    ]

substitutions:
  _REGION: 'asia-northeast1'
  _SERVICE: 'grow-backend'

options:
  logging: CLOUD_LOGGING_ONLY
